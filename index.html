const S_URL = "https://itmwgzryoeeehymbyrdz.supabase.co", 
              S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bXdnenJ5b2VlZWh5bWJ5cmR6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODY2NzcxNywiZXhwIjoyMDg0MjQzNzE3fQ.YJNdFs468N3vIqzvEfQPzg_jAGXsx-rN8YDMqQX793g", 
              sb = supabase.createClient(S_URL, S_KEY), tg = window.Telegram.WebApp;

        let userId = tg.initDataUnsafe?.user?.id?.toString() || "u_test", 
            vids = [], curr = 0, coins = 0, timerId;

        async function boot() {
            tg.expand();
            // 1. Загрузка профиля
            let { data: p } = await sb.from('profiles').select('*').eq('user_id', userId).single();
            if (p) { coins = p.coins; } 
            else { coins = 500; await sb.from('profiles').insert([{user_id: userId, coins: 500}]); }
            document.getElementById('coin-count').innerText = coins;
            
            // 2. ЗАГРУЗКА ВИДЕО (исправлено)
            let { data: v } = await sb.from('videos').select('*');
            vids = (v || []).filter(item => (item.views_done || 0) < item.views_needed);
            
            // 3. ЕСЛИ ЕСТЬ ВИДЕО - ПОКАЗЫВАЕМ ПЕРВОЕ
            if (vids.length > 0) {
                showCurrentVideo();
            } else {
                document.getElementById('player-render').innerHTML = "<div style='padding:20px; color:#555;'>Лента пуста. Загрузите видео первым!</div>";
            }
        }

        // Функция отображения текущего видео в ленте
        function showCurrentVideo() {
            if (!vids[curr]) return;
            document.getElementById('player-render').innerHTML = ""; // Очищаем плеер
            document.getElementById('start-overlay').style.display = 'flex'; // Показываем кнопку Плей
            document.getElementById('timer-box').style.display = 'none';
            document.getElementById('nav-controls').style.display = 'flex';
        }

        function startWatching() {
            if (!vids[curr]) return;
            const vidId = vids[curr].youtube_id;
            
            // Вставляем iframe с автоплеем
            document.getElementById('player-render').innerHTML = `
                <iframe src="https://www.youtube.com/embed/${vidId}?autoplay=1&mute=0&rel=0&playsinline=1" 
                allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('nav-controls').style.display = 'none';
            document.getElementById('timer-box').style.display = 'block';

            let t = 180;
            document.getElementById('seconds').innerText = t;
            
            clearInterval(timerId);
            timerId = setInterval(() => {
                t--;
                document.getElementById('seconds').innerText = t;
                if (t <= 0) {
                    clearInterval(timerId);
                    completeTask();
                }
            }, 1000);
        }

        async function completeTask() {
            coins += 150;
            await sb.from('profiles').update({ coins }).eq('user_id', userId);
            await sb.from('videos').update({ views_done: (vids[curr].views_done || 0) + 1 }).eq('id', vids[curr].id);
            tg.showAlert("Вы получили 150 монет!");
            location.reload(); // Перезагружаем, чтобы обновить баланс и ленту
        }

        async function createOrder() {
            const url = document.getElementById('yt-url').value;
            // Улучшенное извлечение ID видео
            const vidMatch = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=))([\w\-]{11})/);
            const vidId = vidMatch ? vidMatch[1] : null;
            
            if (!vidId) return tg.showAlert("Некорректная ссылка на YouTube!");

            const count = parseInt(document.getElementById('v-count').value);
            const price = count * 300;

            if (coins < price) return tg.showAlert("Недостаточно монет!");
            
            const { error } = await sb.from('videos').insert([{
                youtube_id: vidId,
                views_needed: count,
                duration: 180,
                user_id: userId,
                views_done: 0
            }]);

            if (!error) {
                coins -= price;
                await sb.from('profiles').update({ coins }).eq('user_id', userId);
                tg.showAlert("Задание успешно добавлено!");
                location.reload();
            } else {
                tg.showAlert("Ошибка базы данных: " + error.message);
            }
        }

        async function loadOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = "Загрузка...";
            let { data: myV } = await sb.from('videos').select('*').eq('user_id', userId);
            
            list.innerHTML = (myV || []).map(v => `
                <div class="card">
                    <button class="btn-del" onclick="deleteOrder(${v.id})">Удалить</button>
                    <b>Видео: ${v.youtube_id}</b><br>
                    <small>Прогресс: ${v.views_done}/${v.views_needed}</small>
                </div>
            `).join('') || "У вас пока нет активных заказов";
        }

        async function deleteOrder(id) {
            if (confirm("Удалить задание?")) {
                await sb.from('videos').delete().eq('id', id);
                loadOrders();
            }
        }

        function tab(n, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + n).classList.add('active-page');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function changeVid(dir) {
            if (vids.length <= 1) return;
            curr = (curr + dir + vids.length) % vids.length;
            showCurrentVideo();
        }

        window.onload = boot;
