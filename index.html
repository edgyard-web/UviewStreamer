<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #050505; --panel: #121212; --primary: linear-gradient(45deg, #7f00ff, #e100ff); --accent: #00f2fe; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { padding: 15px; display: flex; justify-content: space-between; background: #000; border-bottom: 1px solid #222; font-weight: bold; }
        .page { display: none; flex: 1; flex-direction: column; padding: 20px; overflow-y: auto; box-sizing: border-box; padding-bottom: 100px; }
        .active-page { display: flex; }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 15px; overflow: hidden; border: 2px solid #333; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        .btn { background: var(--primary); border: none; color: white; padding: 18px; border-radius: 12px; width: 100%; font-weight: bold; font-size: 16px; margin-top: 15px; text-transform: uppercase; }
        .btn:disabled { background: #333; opacity: 0.5; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #111; color: white; box-sizing: border-box; }
        .nav { background: #000; display: flex; position: fixed; bottom: 0; width: 100%; padding: 15px 0 25px; border-top: 1px solid #222; }
        .nav-item { flex: 1; text-align: center; font-size: 10px; color: #555; font-weight: bold; }
        .nav-item.active { color: var(--accent); }
        .card { background: var(--panel); padding: 15px; border-radius: 15px; margin-bottom: 10px; text-align: left; border: 1px solid #222; }
    </style>
</head>
<body>

<div class="header">
    <div>ü§ñ VIEW PRO</div>
    <div style="color:var(--accent)">üí∞ <span id="coins">0</span></div>
</div>

<div id="h" class="page active-page">
    <div class="video-box" id="p-root">
        <div id="v-render"></div>
        <div id="cover" style="height:100%; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="play()">
            <div style="background:var(--primary); padding:15px 30px; border-radius:30px; font-weight:bold;">‚ñ∂ –°–ú–û–¢–†–ï–¢–¨</div>
        </div>
    </div>
    <div id="t-box" style="display:none; font-size:30px; margin-top:20px; color:var(--accent); font-weight:bold;"><span id="sec">180</span> –°–ï–ö.</div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn" style="background:#222" onclick="navVid(-1)">‚¨Ö</button>
        <button class="btn" style="background:#222" onclick="navVid(1)">‚û°</button>
    </div>
</div>

<div id="u" class="page">
    <h3>–ó–ê–ì–†–£–ó–ò–¢–¨ –í–ò–î–ï–û</h3>
    <input type="text" id="url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube" oninput="val()">
    <input type="number" id="cnt" value="10" oninput="val()">
    <p>–¶–µ–Ω–∞: <span id="prc">3000</span> üí∞</p>
    <button id="up-btn" class="btn" onclick="addV()" disabled>–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
</div>

<div id="o" class="page">
    <h3>–ú–û–ò –ó–ê–ö–ê–ó–´</h3>
    <div id="o-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="tab('h',this)">–õ–ï–ù–¢–ê</div>
    <div class="nav-item" onclick="tab('u',this)">–ó–ê–ì–†–£–ó–ò–¢–¨</div>
    <div class="nav-item" onclick="tab('o',this);loadO()">–ó–ê–ö–ê–ó–´</div>
</div>

<script>
    const S_URL = "https://ikvihkyvulxhgeffyeyb.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlrdmloa3l2dWx4aGdlZmZ5ZXliIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDAyNDY3OSwiZXhwIjoyMDg1NjAwNjc5fQ.i28yTAOU3x3MEOBOWGJCum9oH6dYuQ0g0Gz9TbCf2Gw";
    const sb = supabase.createClient(S_URL, S_KEY);
    const tg = window.Telegram.WebApp;
    let uid = tg.initDataUnsafe?.user?.id?.toString() || "test_user", vids = [], cur = 0, bal = 0;

    async function init() {
        tg.expand();
        let { data: p } = await sb.from('profiles').select('*').eq('user_id', uid).single();
        if (!p) { bal = 500; await sb.from('profiles').insert([{user_id: uid, coins: 500}]); } 
        else { bal = p.coins; }
        document.getElementById('coins').innerText = bal;
        let { data: v } = await sb.from('videos').select('*');
        vids = (v || []).filter(i => (i.views_done || 0) < i.views_needed);
        showV();
    }

    function showV() {
        const r = document.getElementById('v-render');
        if (vids.length > 0) { r.innerHTML = ""; document.getElementById('cover').style.display = 'flex'; }
        else { r.innerHTML = "–í–∏–¥–µ–æ –Ω–µ—Ç"; document.getElementById('cover').style.display = 'none'; }
    }

    function play() {
        if (!vids[cur]) return;
        document.getElementById('v-render').innerHTML = `<iframe src="https://www.youtube.com/embed/${vids[cur].youtube_id}?autoplay=1"></iframe>`;
        document.getElementById('cover').style.display = 'none';
        document.getElementById('t-box').style.display = 'block';
        let s = 180;
        let iv = setInterval(async () => {
            s--; document.getElementById('sec').innerText = s;
            if (s <= 0) {
                clearInterval(iv); bal += 150;
                await sb.from('profiles').update({ coins: bal }).eq('user_id', uid);
                await sb.from('videos').update({ views_done: (vids[cur].views_done || 0) + 1 }).eq('id', vids[cur].id);
                location.reload();
            }
        }, 1000);
    }

    function val() {
        const u = document.getElementById('url').value;
        const c = document.getElementById('cnt').value;
        document.getElementById('prc').innerText = c * 300;
        document.getElementById('up-btn').disabled = !(u.includes('youtu') && u.length > 15);
    }

    async function addV() {
        const u = document.getElementById('url').value;
        const id = u.match(/[\w-]{11}/)?.[0];
        const c = parseInt(document.getElementById('cnt').value);
        if (bal < c * 300) return tg.showAlert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
        await sb.from('videos').insert([{ youtube_id: id, views_needed: c, user_id: uid, views_done: 0 }]);
        await sb.from('profiles').update({ coins: bal - (c * 300) }).eq('user_id', uid);
        location.reload();
    }

    async function loadO() {
        const l = document.getElementById('o-list'); l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        let { data: d } = await sb.from('videos').select('*').eq('user_id', uid);
        l.innerHTML = (d || []).map(v => `<div class="card"><b>ID: ${v.youtube_id}</b><br>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${v.views_done}/${v.views_needed} <button onclick="delV(${v.id})" style="color:red; background:none; border:none; float:right;">–£–î–ê–õ–ò–¢–¨</button></div>`).join('') || "–ü—É—Å—Ç–æ";
    }

    async function delV(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { await sb.from('videos').delete().eq('id', id); loadO(); } }

    function tab(p, e) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active-page'));
        document.getElementById(p).classList.add('active-page');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        e.classList.add('active');
    }

    function navVid(d) { if (vids.length > 1) { cur = (cur + d + vids.length) % vids.length; showV(); } }

    window.onload = init;
</script>
</body>
</html>
