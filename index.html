
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: #050505; 
            --primary: linear-gradient(45deg, #7f00ff, #e100ff); 
            --accent: #00f2fe;
            --card-bg: #1a1a1a; 
            --red: #ff4444; 
        }
        body { background: var(--tg-bg); color: white; font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid #222; }
        .page { display: none; flex: 1; flex-direction: column; padding: 20px; text-align: center; overflow-y: auto; box-sizing: border-box; padding-bottom: 100px; }
        .active-page { display: flex; }

        /* –í–∏–¥–µ–æ –ø–ª–µ–µ—Ä Blum Style */
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 15px; overflow: hidden; position: relative; border: 2px solid #333; box-shadow: 0 0 20px rgba(127, 0, 255, 0.4); }
        iframe { width: 100%; height: 100%; border: none; }
        
        .btn-action { background: var(--primary); border: none; color: white; padding: 18px; border-radius: 12px; width: 100%; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 16px; text-transform: uppercase; box-shadow: 0 4px 15px rgba(127, 0, 255, 0.4); }
        .btn-action:disabled { background: #333 !important; box-shadow: none; color: #777; cursor: not-allowed; opacity: 0.5; }
        
        input { width: 100%; padding: 15px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #111; color: white; font-size: 16px; box-sizing: border-box; }
        
        /* –ó–∞–∫–∞–∑—ã */
        .order-card { background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid #333; text-align: left; margin-bottom: 15px; }
        .progress-bar { background: #333; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: var(--accent); height: 100%; width: 0%; transition: width 0.3s; }
        .btn-del { background: var(--red); border: none; color: white; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-bar { background: #000; display: flex; justify-content: space-around; padding: 10px 0 25px 0; border-top: 1px solid #222; position: fixed; bottom: 0; width: 100%; }
        .nav-btn { color: #555; font-size: 10px; cursor: pointer; text-align: center; flex: 1; text-transform: uppercase; font-weight: bold; }
        .nav-btn.active { color: var(--accent); }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight: bold; letter-spacing: 1px;">ü§ñ VIEW PRO</div>
        <div style="color:var(--accent); font-weight: bold;">üí∞ <span id="coin-count">0</span></div>
    </div>

    <div id="page-home" class="page active-page">
        <div class="video-box" id="main-player-box">
            <div id="player-render"></div>
            <div id="start-overlay" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; cursor: pointer;" onclick="startWatching()">
                <div style="background:var(--primary); padding:15px 40px; border-radius:30px; font-weight:bold; font-size: 18px;">‚ñ∂ –°–ú–û–¢–†–ï–¢–¨</div>
                <p style="margin-top:15px; font-size:12px; color:#888;">+150 –º–æ–Ω–µ—Ç –∑–∞ 180 —Å–µ–∫—É–Ω–¥</p>
            </div>
        </div>
        <div id="timer-box" style="display:none; margin-top:20px;">
            <div style="font-size:32px; color:var(--accent); font-weight:bold;"><span id="seconds">180</span> –°–ï–ö.</div>
            <p>–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
        </div>
        <div id="nav-controls" style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action" style="background:#222; box-shadow:none;" onclick="changeVid(-1)">‚¨Ö</button>
            <button class="btn-action" style="background:#222; box-shadow:none;" onclick="changeVid(1)">‚û°</button>
        </div>
    </div>

    <div id="page-upload" class="page">
        <h3 style="text-transform: uppercase;">üöÄ –ù–æ–≤–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</h3>
        <input type="text" id="yt-url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube" oninput="validateUpload()">
        <input type="number" id="v-count" value="10" oninput="validateUpload()">
        <div style="margin:20px 0; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border: 1px solid #333;">
            <p>–í—Ä–µ–º—è: 180 —Å–µ–∫. | –°—Ç–æ–∏–º–æ—Å—Ç—å: <b id="total-price" style="color:var(--accent)">3000</b> üí∞</p>
        </div>
        <button id="publish-btn" class="btn-action" onclick="createOrder()" disabled>–ó–ê–ì–†–£–ó–ò–¢–¨ –í–ò–î–ï–û</button>
    </div>

    <div id="page-orders" class="page">
        <h3 style="text-transform: uppercase;">üìä –ú–û–ò –ó–ê–ö–ê–ó–´</h3>
        <div id="orders-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="tab('home', this)">üè† –õ–ï–ù–¢–ê</div>
        <div class="nav-btn" onclick="tab('upload', this)">üì∑ –ó–ê–ì–†–£–ó–ò–¢–¨</div>
        <div class="nav-btn" onclick="tab('orders', this); loadOrders();">üìä –ó–ê–ö–ê–ó–´</div>
    </div>

    <script>
        const S_URL = "https://ikvihkyvulxhgeffyeyb.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlrdmloa3l2dWx4aGdlZmZ5ZXliIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDAyNDY3OSwiZXhwIjoyMDg1NjAwNjc5fQ.i28yTAOU3x3MEOBOWGJCum9oH6dYuQ0g0Gz9TbCf2Gw";
        const sb = supabase.createClient(S_URL, S_KEY), tg = window.Telegram.WebApp;

        let userId = tg.initDataUnsafe?.user?.id?.toString() || "user_debug", 
            vids = [], curr = 0, coins = 0, timerId;

        async function boot() {
            tg.expand();
            let { data: p } = await sb.from('profiles').select('*').eq('user_id', userId).single();
            if (p) { coins = p.coins; } 
            else { coins = 500; await sb.from('profiles').insert([{user_id: userId, coins: 500}]); }
            document.getElementById('coin-count').innerText = coins;

            let { data: v } = await sb.from('videos').select('*');
            vids = (v || []).filter(item => (item.views_done || 0) < item.views_needed);
            showCurrentVideo();
        }

        function showCurrentVideo() {
            const render = document.getElementById('player-render');
            if (vids.length > 0 && vids[curr]) {
                render.innerHTML = "";
                document.getElementById('start-overlay').style.display = 'flex';
            } else {
                render.innerHTML = "<p style='margin-top:50px; color:#555;'>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</p>";
                document.getElementById('start-overlay').style.display = 'none';
            }
        }

        function startWatching() {
            if (!vids[curr]) return;
            const vidId = vids[curr].youtube_id;
            document.getElementById('player-render').innerHTML = `<iframe src="https://www.youtube.com/embed/${vidId}?autoplay=1&rel=0&playsinline=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('timer-box').style.display = 'block';

            let t = 180;
            document.getElementById('seconds').innerText = t;
            clearInterval(timerId);
            timerId = setInterval(async () => {
                t--;
                document.getElementById('seconds').innerText = t;
                if (t <= 0) {
                    clearInterval(timerId);
                    coins += 150;
                    await sb.from('profiles').update({ coins }).eq('user_id', userId);
                    await sb.from('videos').update({ views_done: (vids[curr].views_done || 0) + 1 }).eq('id', vids[curr].id);
                    tg.showAlert("–ì–æ—Ç–æ–≤–æ! +150 –º–æ–Ω–µ—Ç");
                    location.reload();
                }
            }, 1000);
        }

        function validateUpload() {
            const url = document.getElementById('yt-url').value;
            const count = document.getElementById('v-count').value;
            const btn = document.getElementById('publish-btn');
            document.getElementById('total-price').innerText = count * 300;
            btn.disabled = !(url.length > 15 && url.includes('youtu'));
        }

        async function createOrder() {
            const url = document.getElementById('yt-url').value;
            const vidId = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=))([\w\-]{11})/)?.[1];
            
            if (!vidId) return tg.showAlert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞!");
            const count = parseInt(document.getElementById('v-count').value);
            const price = count * 300;

            if (coins < price) return tg.showAlert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");

            const { error } = await sb.from('videos').insert([{ youtube_id: vidId, views_needed: count, duration: 180, user_id: userId, views_done: 0 }]);
            if (!error) {
                await sb.from('profiles').update({ coins: coins - price }).eq('user_id', userId);
                tg.showAlert("–ó–∞–≥—Ä—É–∂–µ–Ω–æ!");
                location.reload();
            }
        }

        async function loadOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            let { data: myV } = await sb.from('videos').select('*').eq('user_id', userId);
            list.innerHTML = (myV || []).map(v => {
                const pc = (v.views_done / v.views_needed) * 100;
                return `<div class="order-card">
                    <b>ID: ${v.youtube_id}</b><br><small>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${v.views_done}/${v.views_needed}</small>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
                    <button class="btn-del" onclick="deleteOrder(${v.id})">–£–î–ê–õ–ò–¢–¨</button>
                </div>`;
            }).join('') || "–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤";
        }

        async function deleteOrder(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å?")) { await sb.from('videos').delete().eq('id', id); loadOrders(); }
        }

        function tab(n, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + n).classList.add('active-page');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function changeVid(dir) {
            if (vids.length <= 1) return;
            curr = (curr + dir + vids.length) % vids.length;
            showCurrentVideo();
        }

        window.onload = boot;
    </script>
</body>
</html>
